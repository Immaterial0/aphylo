---
title: "Project 2: Augmenting functional information about human genes using probabilistic phylogenetic modeling"
short_title: 
author: "George G. Vega Yon \\linebreak[4] vegayon@usc.edu \\linebreak[4] \\footnotesize Duncan Thomas \\and Paul D. Thomas \\and Paul Marjoram \\and Huaiyu Mi \\and John Morrison \\normalsize"
date: "November 14th, 2018"
institute: "Department of Preventive Medicine \\linebreak[4] University of Southern California"
short_institute: USC
short_author: Vega Yon
output: 
  uscimage::beamer_USCImage:
    includes:
      in_header: notation-def.tex
    toc: false
    highlight: zenburn
    keep_tex: true
section-titles: false
fontsize: 9pt
handout: false
page-number: true
classoption: aspectratio=169
---

```{r setup, include=FALSE}
library(aphylo)
knitr::knit_hooks$set(smallsize = function(before, options, envir) {
    if (before) {
        "\\footnotesize\n\n"
    } else {
        "\n\\normalsize\n\n"
    }
})

options(digits = 4)
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE, echo=FALSE,
  out.width = ".7\\linewidth", fig.align = "center", fig.width = 7, fig.height = 5)
```

## Recap: Model

\begincols

\begincol{.575\linewidth}

1.  A probabilistic model of gene function evolution,

2.  The probability that the root node has the function is $\pi$,

3.  Conditional on its parent state, the probabilties that any given node has to
    either gain or lose a function are $(\gain,\loss)$,
    
4.  Finally, at the leaf node, the probability that a node with no function
    is mislabeled as having the function is $\misszero$. Conversely, the
    probability that a node with a function is mislabeled as not having
    the function is $\missone$.
    
\endcol

\begincol{.375\linewidth}

\begin{table}[tb]
\centering
\begin{tabular}{lm{.7\linewidth}}
\toprule
Parameter & Probability \\ \midrule
$\pi$ & The root node has the function \\
$\gain$ & Gaining a function \\
$\loss$ & Loosing a function \\
$\misszero$ & Mislabeling a 0 \\
$\missone$ & Mislabeling a 1 \\ \bottomrule
\end{tabular}
\caption{Model parameters\label{tab:parameters}}
\end{table}

\endcol
    
\endcols

## Recap: Notation {.m}

\footnotesize

\begincols

\begincol{.49\textwidth}

\includetikz{simple_tree_names.tex}{.5}

\endcol

\begincol{.49\textwidth}

\begin{table}[tb]
\centering
\begin{tabular}{lm{.5\linewidth}}
\toprule
Symbol & Description \\ \midrule 
$\phylo \equiv (\nodes, \edges)$ & Phylogenetic Tree.\\
$\parent{n}$ & Parent of node $n$. \\
$\offspring{n}$ & Offspring of node $n$.\\
$\Ann \equiv \{\ann{n}\}_{n\in\nodes}$ & True annotations.\\
$\AnnObs \equiv \{\annObs{n}\}_{n\in\nodes}$ & Experimental annotations.\\
$\aphylo \equiv (\phylo, \Ann)$ & Annotated Phylogenetic Tree.\\
$\aphyloObs \equiv (\phylo, \AnnObs)$ & Experimentally Annotated Phylogenetic Tree.\\
$\aphyloObs_n$ & Induced Experimentally Annotated Subtree of node $n$. \\
$\aphyloObs_n^c$ & Complement of $\aphyloObs_n$. \\
\bottomrule
\end{tabular}
\caption{Mathematical Notation\label{tab:notation}}
\end{table}

\endcol

\endcols

\normalsize


## Changes from last year

From the formal (statistical) stand

*   Prediction function: Right mathematical definition of the model prediction.

*   New set of parameters: Propensity to report a finding.

*   Flexible model specification: Definition of the likelihood function for different sets of parameters

By products generated during the implementation

*   The `sluRm` R package: A light-weight interface to slurm.

*   Improvements on the `amcmc` R package, notably: automatic convergence.


## Recap: The aphylo R package

Features:

*   Provides a representation of _annotated_ partially ordered trees. \pause

*   Interacts with the `ape` package (most used Phylogenetics R package with ~25K downloads/month) \pause
    
*   Implements the loglikelihood calculation of our model (with C++ under-the-hood).\pause

Some new features

*   Model specification via formula.

*   Added he propensity to report discovery parameters.

*   Two implementations of the prediction function (using a post-order algorithm as suggested by
    Prof. Suchard), and a brute force method... we use this for unit tests.
    
*   (in the `amcmc` R package) Convergence monitoring and automatic stop of the MCMC
    algorithm


```{r dgp, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
library(aphylo)

# Setting the seed and simulating the data
set.seed(2)
x <- sim_annotated_tree(40, P = 2)

# Droping some annotations
x <- rdrop_annotations(x, .5)
```

## Nice visualizations

```{r tree, fig.cap="Annotated Phylogenetic Tree"}
plot(x, main = "")
```

----

```{r likelihood, fig.cap="Surface of the likelihood of a given annotated tree."}
plot_logLik(x ~ mu + psi + Pi)
```

----

```{r pred, fig.cap="Prediction Accuracy: Observed versus predicted values", cache=TRUE, out.width=".5\\linewidth"}
ans <- aphylo_mcmc(x ~ mu + psi + Pi, priors = bprior())
plot(prediction_score(ans), main = "", which.fun=1L)
```



## Flexible model specification

Automatic specification of the likelihood function, e.g.

\small

*   `x ~ mu` baseline model

*   `x ~ mu + psi + Pi` model including mislabeling and root node probabilities

*   `x ~ mu + Pi` same as before, but excluding mislabeling

*   `x ~ mu + psi(1) + Pi` mislabeling of 1 is fixed

*   `x ~ mu + psi(0, 1) + Pi` mislabeling of 0s and 1s is fixed

\normalsize

## Flexible model specification

\footnotesize

```{r model-example}
ans
```

\normalsize


## Results on the new specification (adventure)

The data generating process was `x ~ mu + psi + eta + Pi` (`eta` are the propensity
to publication parameters).

\begincols

\begincol{.40\linewidth}

\begin{figure}\centering
\caption{Correct specification (includes `eta`)}
\includegraphics[width=1\linewidth]{bad-full-model.png}
\end{figure}

\endcol

\begincol{.40\linewidth}

\begin{figure}\centering
\caption{Miss specified model (does not include `eta`). Missigness is confounded with propensity to fail to report}
\includegraphics[width=1\linewidth]{bad-pub-prop.png}
\end{figure}

\endcol

\endcols

## Concluding remarks

A parsimonious model of gene functions: easy to apply on a large scale (we already ran some simulations using all 13,000 trees from PantherDB... and it took us less than 1 ~~week~~ hour with ~~10~~ 240 processors ~~only~~).\pause 

-   Already implemented, we are currently in the stage of ~~writing the paper and setting up the simulation study~~ finishing and submiting the paper.\pause

-   For the next steps, we are evaluating whether to include or how to include:\pause
    
    *   Type of node: speciation, duplication, horizontal transfer.
    
    *   Branch lengths
    
    *   Correlation structure between functions
    
    *   ~~Using Taxon Constraints to improve predictions~~
    
    *   Hierarchical model: Use fully annotated trees by curators as prior information.
    
-   We are still unsure about how to procede with the software: R journal? Journal of Open Source Software? Journal of Statistical Software? Bioinformatics? etc.

----

\begin{center}
\huge
\color{USCCardinal}{\textbf{Thank you!}}
\end{center}

\maketitle

